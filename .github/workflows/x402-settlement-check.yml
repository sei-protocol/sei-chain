name: 🔒 x402 Settlement Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  x402:
    name: x402 Payment Validation
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🧰 Ensure jq is installed
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: 🔎 Run x402 Owed Table Script
        id: owed
        shell: bash
        run: |
          set -e
          if [ ! -f ./x402.sh ]; then
            echo "❌ ERROR: x402.sh not found at repo root." >&2
            exit 1
          fi
          if [ -f ./x402/receipts.json ]; then
            bash ./x402.sh ./x402/receipts.json > owed.txt
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "⚠️ No receipts.json found at ./x402/receipts.json" > owed.txt
            echo "" >> owed.txt
            echo "TOTAL OWED: 0" >> owed.txt
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: 📤 Upload `owed.txt` as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: x402-owed
          path: owed.txt

      - name: 💬 Post Owed Summary to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const owed = fs.readFileSync('owed.txt', 'utf8');
            const commentBody = [
              '### 🔒 x402 Payment Snapshot',
              '> _Verified settlement owed based on authorship tracing protocol._',
              '',
              '```txt',
              owed.trim(),
              '```'
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const existing = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('🔒 x402 Payment Snapshot')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: commentBody
              });
            }

  x402_settlement:
    name: x402 Settlement Receipt
    runs-on: ubuntu-latest
    steps:
      - name: ✅ Confirm Settlement Script Ran
        run: echo "✅ x402 settlement logic executed cleanly"
