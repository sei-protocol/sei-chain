name: "ðŸ”¥ Deploy Kin Contract â€“ AbandonedLion"

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

jobs:
  deploy:
    if: contains(github.event.comment.body, '/abandonedlion deploy')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        network: [sei, base, arbitrum]
    env:
      DRY_RUN: false

    steps:
      - name: "ðŸ¦ Checkout Repository"
        uses: actions/checkout@v3

      - name: "ðŸ¦ Set Up Foundry"
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: "ðŸ§ª Parse for Dry Run"
        id: parse
        run: |
          if [[ "${{ github.event.comment.body }}" == *"--dry"* ]]; then
            echo "DRY_RUN=true" >> $GITHUB_ENV
          else
            echo "DRY_RUN=false" >> $GITHUB_ENV
          fi

      - name: "ðŸ”¥ Forge Build"
        run: forge build

      - name: "ðŸš€ Deploy to ${{ matrix.network }}"
        if: env.DRY_RUN == 'false'
        id: deploy
        run: |
          case "${{ matrix.network }}" in
            sei)
              RPC="${{ secrets.SEI_RPC_URL }}" ;;
            base)
              RPC="${{ secrets.BASE_RPC_URL }}" ;;
            arbitrum)
              RPC="${{ secrets.ARBITRUM_RPC_URL }}" ;;
          esac

          TX_OUTPUT=$(forge create SeiWordZK \
            --rpc-url "$RPC" \
            --private-key "${{ secrets.KIN_DEPLOYER_KEY }}" \
            --constructor-args 0xYourVerifierAddress \
            --json)

          echo "$TX_OUTPUT" > deployment-${{ matrix.network }}.json
          echo "DEPLOYED_ADDR=$(echo $TX_OUTPUT | jq -r '.deployedTo')" >> $GITHUB_ENV
          echo "TX_HASH=$(echo $TX_OUTPUT | jq -r '.transactionHash')" >> $GITHUB_ENV

      - name: "ðŸ’¬ Comment Deployment"
        if: env.DRY_RUN == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const net = '${{ matrix.network }}';
            const msg = [
              `**âœ… AbandonedLion Deployed to ${net}**`,
              '',
              `**Address**: \`${process.env.DEPLOYED_ADDR}\``,
              `**TX Hash**: \`${process.env.TX_HASH}\``,
              '',
              '_Powered by Kin & AbandonedLion deploy script_'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue?.number || context.payload.pull_request?.number,
              body: msg
            });

      - name: "ðŸ§ª Dry Run Confirmation"
        if: env.DRY_RUN == 'true'
        run: echo "ðŸ§ª Dry run successful: build completed, no contract deployed."
