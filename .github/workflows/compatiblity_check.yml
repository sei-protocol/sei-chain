name: üß† Codex Go Syntax Guard

on:
  push:
    branches: [main, evm, evm1]
  pull_request:
    branches: [main, evm, evm1]
  workflow_dispatch:

jobs:
  go-syntax-check:
    name: üß™ Codex Go Top-Level Syntax Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Set up Go environment
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - name: üîç Detect top-level assignments ( := )
        id: detect
        run: |
          echo "üîç Scanning go-ethereum/core/vm/ for invalid top-level := usage..."
          mkdir -p codex-logs

          BAD_LINES=$(grep -rPn '^[^/]*:=.*$' go-ethereum/core/vm/ | grep -v 'func' || true)

          if [[ -n "$BAD_LINES" ]]; then
            echo "$BAD_LINES" > codex-logs/codex_go_patch.log
            echo "::warning file=go-ethereum/core/vm/contracts.go::Top-level := assignments found!"
            echo "violation=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ No top-level syntax violations detected."
            echo "violation=false" >> $GITHUB_OUTPUT
          fi

      - name: üõ†Ô∏è Auto-patch into init() (Codex assist)
        if: steps.detect.outputs.violation == 'true'
        run: |
          FILE="go-ethereum/core/vm/contracts.go"
          INIT_BLOCK="// codex:init-wrap"

          echo "üõ†Ô∏è Applying auto-patch to $FILE"

          # Create init() if missing
          if ! grep -q "$INIT_BLOCK" "$FILE"; then
            echo -e "\nfunc init() {\n    $INIT_BLOCK\n}" >> "$FILE"
          fi

          # Move rogue := lines into init()
          sed -i.bak '/^[^/]*:=.*$/ {
            s/^/\/\/ Codex moved: /
            h
            s/^.*:=/    /
            G        
            s/\n/\n    /
            s/$/ \/\/ ‚Üê auto-moved by Codex/
          }' "$FILE"

          echo "‚úÖ Codex wrapped invalid lines into init() block."

      - name: üì§ Upload Codex patch log
        uses: actions/upload-artifact@v3
        with:
          name: codex-go-syntax-log
          path: codex-logs/codex_go_patch.log
