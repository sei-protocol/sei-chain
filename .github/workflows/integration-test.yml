name: Docker Integration Test

on:
  push:
    branches:
      - main
      - seiv2
  pull_request:
    branches:
      - main
      - seiv2
      - evm

defaults:
  run:
    shell: bash

jobs:
  wasm-module-test:
    name: Integration Test (Wasm Module)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Python and system deps
        run: |
          pip3 install pyyaml
          sudo apt-get update && sudo apt-get install -y jq

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.21

      - name: Start 4-node Docker cluster
        run: |
          make clean
          INVARIANT_CHECK_INTERVAL=10 make docker-cluster-start &

      - name: Wait for cluster to start (launch.complete = 4)
        run: |
          echo "[⏳] Waiting for launch.complete to have 4 lines..."
          for i in {1..30}; do
            COUNT=$(cat build/generated/launch.complete 2>/dev/null | wc -l || echo 0)
            echo "Attempt $i → launch.complete has $COUNT lines"
            if [ "$COUNT" -eq 4 ]; then
              echo "[✅] launch.complete complete"
              break
            fi
            sleep 10
          done

      - name: Start RPC node
        run: make run-rpc-node-skipbuild &

      - name: Wait for chain to produce blocks
        run: |
          echo "[⏳] Waiting for block height > 0..."
          for i in {1..30}; do
            HEIGHT=$(seid status | jq -r '.SyncInfo.latest_block_height' || echo 0)
            echo "Attempt $i → Height: $HEIGHT"
            if [ "$HEIGHT" -gt 0 ]; then
              echo "[✅] Chain is producing blocks."
              break
            fi
            sleep 10
          done

          FINAL_HEIGHT=$(seid status | jq -r '.SyncInfo.latest_block_height' || echo 0)
          if [ "$FINAL_HEIGHT" -eq 0 ]; then
            echo "[❌] Timeout: Chain never produced blocks."
            seid status || true
            exit 1
          fi

      - name: Run Wasm Module Integration Tests
        run: |
          docker exec sei-node-0 integration_test/contracts/deploy_timelocked_token_contract.sh
          python3 integration_test/scripts/runner.py integration_test/wasm_module/timelocked_token_delegation_test.yaml
          python3 integration_test/scripts/runner.py integration_test/wasm_module/timelocked_token_admin_test.yaml
          python3 integration_test/scripts/runner.py integration_test/wasm_module/timelocked_token_withdraw_test.yaml
          docker exec sei-node-0 integration_test/contracts/deploy_timelocked_token_contract.sh
          python3 integration_test/scripts/runner.py integration_test/wasm_module/timelocked_token_emergency_withdraw_test.yaml

      - name: Upload Wasm Module Logs (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wasm-module-logs
          path: |
            integration_test/output/
