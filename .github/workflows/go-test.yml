name: Sei Cross-Architecture Build & Artifacts

on:
  workflow_call:
  pull_request:
  push:
    branches:
      - main
      - release/**

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.sha }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.24'
  LEDGER_ENABLED: false
  GO_TEST_TIMEOUT: 30m

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        module:
          - name: sei-chain
            path: ./
            tags: ""
          - name: sei-cosmos
            path: ./sei-cosmos
            tags: "ledger test_ledger_mock"
          - name: sei-db
            path: ./sei-db
            tags: ""
          - name: sei-tendermint
            path: ./sei-tendermint
            tags: ""
          - name: sei-wasmd
            path: ./sei-wasmd
            tags: "ledger test_ledger_mock"
          - name: sei-wasmvm
            path: ./sei-wasmvm
            tags: ""

    name: "Cross-Arch Build & Verify ${{ matrix.module.name }} on ${{ matrix.os }}"

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          submodules: true

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install OS-specific dependencies
        run: |
          echo "OS: $RUNNER_OS | Module: ${{ matrix.module.name }} | Path: ${{ matrix.module.path }}"
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update -qq
            sudo apt-get install -y build-essential git curl
            sudo docker image prune --all --force
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            xcode-select --print-path || xcode-select --install
          elif [[ "$RUNNER_OS" == "Windows" ]]; then
            choco install visualstudio2019buildtools -y
          fi

      - name: Download dependencies
        working-directory: ${{ matrix.module.path }}
        run: go mod download

      - name: Build module
        working-directory: ${{ matrix.module.path }}
        run: |
          make install
          make build

      - name: Go test with race detector
        working-directory: ${{ matrix.module.path }}
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            go test -race -tags="${{ matrix.module.tags }}" -timeout="${{ env.GO_TEST_TIMEOUT }}" -covermode=atomic -coverprofile=coverage.out ./...
          else
            go test -race -tags="${{ matrix.module.tags }}" -timeout="${{ env.GO_TEST_TIMEOUT }}" -covermode=atomic -coverprofile=coverage.out ./...
          fi

      - name: Verify binary
        working-directory: ${{ matrix.module.path }}
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            BINARY=".\\build\\seid.exe"
          else
            BINARY="./build/seid"
          fi
          if [[ ! -f "$BINARY" ]]; then
            echo "ERROR: Binary $BINARY does not exist!"
            ls -R ./build
            exit 1
          fi
          "$BINARY" version --long

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          name: '${{ matrix.module.name }}-coverage'
          files: ${{ matrix.module.path }}/coverage.out
          fail_ci_if_error: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: '${{ matrix.os }}-${{ matrix.module.name }}-binaries'
          path: ${{ matrix.module.path }}/build
          fail_ci_if_error: true
