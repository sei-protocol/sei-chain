name: Sei Cross-Architecture Build & Artifacts

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

env:
  LEDGER_ENABLED: false
  GO_VERSION: '1.24'

defaults:
  run:
    shell: bash

jobs:
  # ========================================
  # Cross-Architecture Build Matrix
  # ========================================
  build:
    name: "Cross-Arch Build & Verify"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        module:
          - name: sei-chain
            path: ./
          - name: sei-cosmos
            path: ./sei-cosmos
            tags: ledger test_ledger_mock
          - name: sei-ibc-go
            path: ./sei-ibc-go
          - name: sei-tendermint
            path: ./sei-tendermint
          - name: sei-wasmd
            path: ./sei-wasmd
            tags: ledger test_ledger_mock
          - name: sei-wasmvm
            path: ./sei-wasmvm

    steps:
      # -----------------------
      # Checkout & Modules
      # -----------------------
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          submodules: true

      # -----------------------
      # Go Setup & Cache
      # -----------------------
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      # -----------------------
      # OS-specific Dependencies
      # -----------------------
      - name: Install system deps & verify environment
        run: |
          echo "OS: $RUNNER_OS | Module: ${{ matrix.module.name }} | Path: ${{ matrix.module.path }}"
          go version
          echo "GOOS: $(go env GOOS) | GOARCH: $(go env GOARCH)"

          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update -qq
            sudo apt-get install -y build-essential
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            xcode-select --print-path || xcode-select --install --verbose
          elif [[ "$RUNNER_OS" == "Windows" ]]; then
            choco install visualstudio2019buildtools -y
          fi

      # -----------------------
      # Download Dependencies & Build
      # -----------------------
      - name: Download deps & build
        working-directory: ${{ matrix.module.path }}
        run: |
          go mod download
          make install
          make build

      # -----------------------
      # Verify Binaries
      # -----------------------
      - name: Verify binaries
        working-directory: ${{ matrix.module.path }}
        run: |
          BINARY="./build/seid"
          [[ "$RUNNER_OS" == "Windows" ]] && BINARY=".\\build\\seid.exe"

          if command -v "$BINARY" >/dev/null 2>&1; then
            "$BINARY" version --long || { echo "Installed binary check failed"; exit 1; }
          fi

          if [[ -f "$BINARY" ]]; then
            "$BINARY" version --long || { echo "Build binary check failed"; exit 1; }
          fi

      # -----------------------
      # Upload Artifacts
      # -----------------------
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-${{ matrix.module.name }}-binaries
          path: ${{ matrix.module.path }}/build
