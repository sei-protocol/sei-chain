name: SEI Blocktests – Mnemonic & Balance Check

on:
  workflow_dispatch:
    inputs:
      mnemonic_list:
        description: "Enter mnemonics separated by newline"
        required: true
        type: string

jobs:
  check-balances:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install CosmJS CLI
        run: npm install -g @cosmjs/cli

      - name: Create results directory
        run: mkdir -p results

      - name: Initialize CSV
        run: echo "Mnemonic,SEI Address,usei Balance" > results/valid_sei_accounts.csv

      - name: Check mnemonics and log valid balances
        env:
          REST_URL: https://rest.sei-apis.com
          MNEMONIC_LIST: ${{ inputs.mnemonic_list }}
        run: |
          echo "$MNEMONIC_LIST" | while read -r MNEMONIC; do
            echo "🔑 Checking mnemonic: $MNEMONIC"
            ADDR=$(npx --yes @cosmjs/cli --prefix sei --hd-path "m/44'/118'/0'/0/0" <<< "import { getAddressFromMnemonic } from '@cosmjs/cli'; getAddressFromMnemonic('$MNEMONIC').then(a => console.log(a)).catch(e => console.error(e))")
            
            ADDR=$(echo "$ADDR" | grep -Eo 'sei1[0-9a-z]{38}' || true)
            echo "📬 Address: $ADDR"

            if [[ -z "$ADDR" ]]; then
              echo "❌ Failed to derive address."
              continue
            fi

            RESPONSE=$(curl -s "$REST_URL/cosmos/bank/v1beta1/balances/$ADDR")
            BAL=$(echo "$RESPONSE" | jq -r '.balances[] | select(.denom == "usei") | .amount')

            if [[ -z "$BAL" || "$BAL" == "null" || "$BAL" == "0" ]]; then
              echo "⚠️ No balance for $ADDR"
            else
              echo "✅ $ADDR has $BAL usei"
              echo "\"$MNEMONIC\",\"$ADDR\",\"$BAL\"" >> results/valid_sei_accounts.csv
            fi
            echo "---------------------------"
          done

      - name: Upload results
        uses: actions/upload-artifact@v3
        with:
          name: valid-sei-accounts
          path: results/valid_sei_accounts.csv
