name: SEI Blocktests â€“ Mnemonic & Balance Check

on:
  workflow_dispatch:
    inputs:
      mnemonic_list:
        description: "Newline-separated mnemonics"
        required: true
        type: string

jobs:
  check-balances:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '18' }

      - run: npm install -g @cosmjs/cli
      - run: mkdir -p results && echo "Mnemonic,SEI Address,usei Balance" > results/valid_sei_accounts.csv

      - name: Scan mnemonics
        env:
          REST_URL: https://rest.sei-apis.com
          MNEMONIC_LIST: ${{ inputs.mnemonic_list }}
        run: |
          echo "$MNEMONIC_LIST" | while read -r M; do
            echo "ðŸ”‘ $M"
            A=$(npx --yes @cosmjs/cli --prefix sei --hd-path "m/44'/118'/0'/0/0" <<< "import { getAddressFromMnemonic } from '@cosmjs/cli'; getAddressFromMnemonic('$M').then(console.log).catch(console.error)")
            A=$(echo "$A" | grep -Eo 'sei1[0-9a-z]{38}' || true)
            [ -z "$A" ] && echo "âŒ Invalid" && continue
            B=$(curl -s "$REST_URL/cosmos/bank/v1beta1/balances/$A" | jq -r '.balances[] | select(.denom=="usei") | .amount')
            [ -z "$B" -o "$B" = "0" ] && echo "âš ï¸ No balance" || echo "âœ… $A: $B" && echo "\"$M\",\"$A\",\"$B\"" >> results/valid_sei_accounts.csv
          done

      - uses: actions/upload-artifact@v3
        with:
          name: valid-sei-accounts
          path: results/valid_sei_accounts.csv
