The `cryptosim` benchmark simulates basic cryptocurrency transfer transactions. It's a benchmark designed to be
predictive of DB performance under a heavy crypto transfer load.

# Running Cryptosim

To run this benchmark, execute the following from within the cryptosim directory:

```
./run.sh ./config/basic-config.json
```

# Configuring Cryptosim

You can modify or provide a different config file for this benchmark. Available configuration options and their
defaults are defined in the [cryptosim config struct](./cryptosim_config.go). Fields in the json file should
mirror struct field names exactly.

# Data Persistence

The cryptosim benchmark writes database files. If provided with those database files at startup time, the cryptosim
benchmark can continue running with that database. This may be useful when operating on large data sets that require
significant setup time.

Note that if continuing from an earlier run, you may not alter the `Seed`, `CannedRandomSize`, or 
`AccountKeySize` parameters, since keys are deterministically derived from these configuration values.

# Transaction Model

The goal of this benchmark is to generate database load similar to that generated by processing ERC20 transactions.

Each "transaction" performs the following operations (in no particular order):

- Randomly select a source and a destination account. For both:
    - Performs an account read + write (native balance, nonce, codehash)
    - Performs a read + write on a storage slot
- Randomly selects a simulated ERC20 contract and reads it
- Performs a read+write on an account that "collects gas fees"

# Future Work

The following features might be useful to add to this benchmark:

- Metrics collection
    - Measurements of size of data on disk vs. keys in the database
    - Detailed latency breakdown
    - Measurements of variance (e.g. p99 vs. just average)
    - Memory utilization
    - Raw disk IO utilization
    - Compaction overhead
    - Metrics exported by the underlying DB
- Prometheus/Grafana dashboards to visualize metrics
- More exotic key access patterns


# Setting Up Prometheus / Grafana

To set up local prometheus/grafana instances, run the following. You must have docker installed.

```
./metrics/start-prometheus.sh
./metrics/start-grafana.sh
```

Then, navigate to http://localhost:3000/ in a web browser to reach the grafana UI. Username and password are "admin".

There is a pre-built dashboard containing visualizations for benchmark metrics in `metrics/dashboard.json` that 
you can import into grafana.


You can stop these services by killing their containers, or by running the following:

```
./metrics/stop-prometheus.sh
./metrics/stop-grafana.sh
```

# Running in AWS

To set up this benchmark on an AWS machine, perform the following steps:

1. Clone the repo

```
git clone https://github.com/sei-protocol/sei-chain.git
```

2. Install dependencies

```
cd ./sei-chain/sei-db/state_db/bench/cryptosim
./tools/setup-ubuntu.sh
```

3: Start Prometheus Server (optional)

```
cd ./sei-chain/sei-db/state_db/bench/cryptosim
./metrics/start-prometheus.sh
```

3. Start the Benchmark

Optional: start a tmux session (the install script installs tmux). This will allow the benchmark to run
even if your connection is interrupted.

```
cd sei-chain/sei-db/state_db/bench/cryptosim
./run.sh ./config/basic-config.json
```