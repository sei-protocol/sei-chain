- name: Test Major Release Upgrade
  inputs:
    - cmd: echo "v2.0.0"
      env: VERSION
    # PASS PROPOSAL FOR MAJOR UPGRADE
    # Get block for 30s from now
    - cmd: proposal_target_height.sh 30
      env: TARGET_HEIGHT
      node: sei-node-0

    # Submit the software upgrade proposal
    - cmd: proposal_submit.sh $TARGET_HEIGHT major $VERSION
      env: PROPOSAL_ID
      node: sei-node-0

    # Vote with all nodes
    - cmd: proposal_vote.sh $PROPOSAL_ID
      node: sei-node-0
    - cmd: proposal_vote.sh $PROPOSAL_ID
      node: sei-node-1
    - cmd:  proposal_vote.sh $PROPOSAL_ID
      node: sei-node-2
    - cmd:  proposal_vote.sh $PROPOSAL_ID
      node: sei-node-3

    # Wait for the proposal to pass
    - cmd: proposal_wait_for_pass.sh $PROPOSAL_ID
      node: sei-node-0

    # EXECUTE UPGRADE SCENARIOS
    # Confirm no panic before upgrade and block height
    - cmd: verify_running.sh
      node: sei-node-0
      env: RUNNING_BEFORE_UPGRADE_NODE_0
    - cmd: verify_running.sh
      node: sei-node-1
      env: RUNNING_BEFORE_UPGRADE_NODE_1
    - cmd: verify_running.sh
      node: sei-node-2
      env: RUNNING_BEFORE_UPGRADE_NODE_2
    - cmd: verify_running.sh
      node: sei-node-3
      env: RUNNING_BEFORE_UPGRADE_NODE_3

    # Upgrade to major release (node 0)
    - cmd: upgrade_seid.sh $VERSION
      node: sei-node-0

    # Confirm both nodes are not running because they upgraded too early
    - cmd: verify_panic.sh
      node: sei-node-0
      env: PANIC_AFTER_EARLY_UPGRADE_NODE_0

    # Wait for the target height (using live node)
    - cmd: wait_for_height.sh $TARGET_HEIGHT
      node: sei-node-2

    # Confirm panic and UPGRADE NEEDED log message for non-upgraded node
    - cmd: verify_panic.sh
      node: sei-node-2
      env: PANIC_AT_BLOCK_HEIGHT_NODE_2
    - cmd: verify_panic.sh
      node: sei-node-3
      env: PANIC_AT_BLOCK_HEIGHT_NODE_3
    - cmd: verify_upgrade_needed_log.sh $TARGET_HEIGHT $VERSION
      node: sei-node-2
      env: LOG_AT_BLOCK_HEIGHT_NODE_2
    - cmd: verify_upgrade_needed_log.sh $TARGET_HEIGHT $VERSION
      node: sei-node-3
      env: LOG_AT_BLOCK_HEIGHT_NODE_3

    # Upgrade all nodes to major release
    - cmd: upgrade_seid.sh $VERSION
      node: sei-node-0
    - cmd: upgrade_seid.sh $VERSION
      node: sei-node-1
    - cmd: upgrade_seid.sh $VERSION
      node: sei-node-2
    - cmd: upgrade_seid.sh $VERSION
      node: sei-node-3

    # Confirm all nodes are running after upgrade
    - cmd: verify_running.sh
      node: sei-node-0
      env: RUNNING_UPGRADED_NODE_0
    - cmd: verify_running.sh
      node: sei-node-1
      env: RUNNING_UPGRADED_NODE_1
    - cmd: verify_running.sh
      node: sei-node-2
      env: RUNNING_UPGRADED_NODE_2
    - cmd: verify_running.sh
      node: sei-node-3
      env: RUNNING_UPGRADED_NODE_3

  verifiers:
    # Nodes are running before upgrade
    - type: eval
      expr: RUNNING_BEFORE_UPGRADE_NODE_0 == "PASS"
    - type: eval
      expr: RUNNING_BEFORE_UPGRADE_NODE_1 == "PASS"
    - type: eval
      expr: RUNNING_BEFORE_UPGRADE_NODE_2 == "PASS"
    - type: eval
      expr: RUNNING_BEFORE_UPGRADE_NODE_3 == "PASS"

    # Upgraded nodes panic because they were upgraded too early
    - type: eval
      expr: PANIC_AFTER_EARLY_UPGRADE_NODE_0 == "PASS"

    # Non-Upgraded nodes panic after the block height
    - type: eval
      expr: PANIC_AT_BLOCK_HEIGHT_NODE_2 == "PASS"
    - type: eval
      expr: PANIC_AT_BLOCK_HEIGHT_NODE_3 == "PASS"
    - type: eval
      expr: LOG_AT_BLOCK_HEIGHT_NODE_2 == "PASS"
    - type: eval
      expr: LOG_AT_BLOCK_HEIGHT_NODE_3 == "PASS"

    # After upgrade, all nodes are running
    - type: eval
      expr: RUNNING_UPGRADED_NODE_0 == "PASS"
    - type: eval
      expr: RUNNING_UPGRADED_NODE_1 == "PASS"
    - type: eval
      expr: RUNNING_UPGRADED_NODE_2 == "PASS"
    - type: eval
      expr: RUNNING_UPGRADED_NODE_3 == "PASS"